<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Architecture - Trumpet -- HDFS Notification System for Apache Hadoop</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  <link href="../site/css/base.css" rel="stylesheet">
  <link href="../site/css/bootstrap-custom.min.css" rel="stylesheet">
  <link href="../site/css/font-awesome-4.0.3.css" rel="stylesheet">
  <link href="../site/css/highlight.css" rel="stylesheet">

  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script>
  <script src="../site/js/base.js"></script>
  <script src="../site/js/bootstrap-3.0.3.min.js"></script>
  <script src="../site/js/highlight.pack.js"></script>
  <script src="../site/js/jquery-1.10.2.min.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Trumpet -- HDFS Notification System for Apache Hadoop</a>
        
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
      <ul class="current">
    
        
            <li class="toctree-l1 ">
                <a class="" href="..">Trumpet Home</a>
                
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../changelog/">Changelog</a>
                
            </li>
        

    
        
            <li class="toctree-l1 current">
                <a class="current" href="./">Architecture</a>
                
                    <ul>
                    
                        <li class="toctree-l3"><a href="#poll-the-edit-log-directory">Poll the edit log directory</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#publish-into-kafka">Publish into Kafka</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#leader-election">Leader Election</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#resume-from-previous-run">Resume from previous run</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#rolling-upgrade">Rolling upgrade</a></li>
                        
                    
                        <li class="toctree-l3"><a href="#zookeeper-separation">Zookeeper separation</a></li>
                        
                    
                    </ul>
                
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../build/">Build Deploy and Run</a>
                
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../operations/">Operations</a>
                
            </li>
        

    
        
            <li class="toctree-l1 ">
                <a class="" href="../license/">License</a>
                
            </li>
        

    
</ul>

      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Trumpet -- HDFS Notification System for Apache Hadoop</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
    <li>Architecture</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              <p>The strongest requirement behind this project is to be completely decoupled from the NameNode for reading the transactions 
and streaming them to multiple clients.</p>
<p>The selected approach is thus to read the edits log file directly from the local filesystem from either the NameNode or, 
more recommended, the JournalNode, and stream the interesting transactions into <a href="http://kafka.apache.org">Kafka</a>. 
Many clients might in turn read from Kafka the complete set of transactions. The process of reading the edits log 
is independent from the NameNode or JournalNode and thus non-intrusive at all. 
And the Kafka cluster can be scaled out independently.</p>
<p><img alt="Trumpet Flow Diagram 1" src="../trumpet-flow.png" title="Trumpet Flow Diagram 1.0" /></p>
<h2 id="poll-the-edit-log-directory">Poll the edit log directory</h2>
<p>Because Trumpet is reading from outside the NameNode / JournalNode process, the easiest solution is to poll the edit log 
directory, to find the latest edit log file and read the transaction from there. 
This edit log directory is given by the configuration option <code>dfs.journalnode.name.dir</code> (<code>dfs.namenode.name.dir</code> respectively 
for the NameNode), and is later referred as <code>dfs.*.name.dir</code>.</p>
<p>Based on naming convention of the edit log dir (read more on that here: http://hortonworks.com/blog/hdfs-metadata-directories-explained/), 
it's straight forward to find the file containing a given transaction and resuming the read from this transaction. 
Hadoop source code provides all the primitive functions to achieve that in few lines of code.</p>
<h2 id="publish-into-kafka">Publish into Kafka</h2>
<p>Kafka publisher subscriber model is a good fit to push the transactions into and allow several clients to read from. 
In current implementation supports <a href="https://archive.apache.org/dist/kafka/0.8.2.1/RELEASE_NOTES.html">Kafka 0.8.2.1</a> 
and <a href="https://archive.apache.org/dist/kafka/0.8.1.1/RELEASE_NOTES.html">Kafka 0.8.1.1</a>. 
The topic contains one single partition to guarantee consistent ordering of the transactions. 
This might change in the future. Several replica are however strongly recommended.</p>
<p>Trumpet requires to have the topic created in advance. The default topic name is <code>hdfs.inotify.events</code>.
An example of topic creation would be:</p>
<ul>
<li>Kakfa 0.8.1</li>
</ul>
<pre><code>$ bin/kafka-topic.sh --create --zookeeper &lt;zk_ip:2181&gt; --replication-factor 4 --partitions 1 --topic hdfs.inotify.events
</code></pre>

<ul>
<li>Kakfa 0.8.2</li>
</ul>
<pre><code>$ kafka-topics --create --zookeeper &lt;zk_ip:2181&gt; --replication-factor 4 --partitions 1 --topic hdfs.inotify.events
</code></pre>

<p>Of course the scalability of the client applications reading the transactions will be influenced by 
the scalability of your Kafka cluster. Trumpet does not guarantee any transaction or reader persistence 
to the client application. The work is delegated to the clients.</p>
<h2 id="leader-election">Leader Election</h2>
<p>Hadoop runs with HA in mind, and this project follows the same concept. Trumpet is designed to run alongside the JournalNode 
(or NameNode) process, reading from the local <code>dfs.*.name.dir</code> directory. The idea is to run one Trumpet process per JournalNode, 
the processes running a leader election in Zookeeper using <a href="http://curator.apache.org/">Curator</a> 
<a href="http://curator.apache.org/curator-recipes/leader-election.html">recipe</a> to guarantee only one active process 
at the same time. The processes are also monitoring the JournalNode process, and release the leadership 
if the JournalNode process died.</p>
<h2 id="resume-from-previous-run">Resume from previous run</h2>
<p>Once a Trumpet process become active (leader), it will find out from Kafka which was the latest published transaction, 
resuming the operation from there (or, in case of prolonged downtime, resume with the first found transaction in 
the local <code>dfs.*.name.dir</code> directory.</p>
<h2 id="rolling-upgrade">Rolling upgrade</h2>
<p>In case of production usage of Trumpet, rolling upgrades need to be addressed. With its leader election 
feature, Trumpet rolling upgrade is as easy as upgrading one Trumpet worker at the time. 
A tool which tells you who are the Trumpet workers and which one is active is also provided, 
see below.</p>
<h2 id="zookeeper-separation">Zookeeper separation</h2>
<p>Zookeeper is a critical component of the Hadoop infrastructure, and it's common to split Zookeeper cluster, 
one for the infrastructure components, like Kafka, NameNode etc... and another Zookeeper for more 
user-space applications.
In Trumpet, you can either use one Zookeeper cluster, or split the Zookeeper usages between 
Kafka discovery and leader election. Use:</p>
<ul>
<li><code>--zk.connect</code> if you have one Zookeeper cluster</li>
<li><code>--zk.connect.kafka</code> and <code>--zk.connect.user</code> if you have two Zookeeper clusters.</li>
</ul>
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../build/" class="btn btn-neutral float-right" title="Build Deploy and Run"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../changelog/" class="btn btn-neutral" title="Changelog"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
    <!-- Copyright etc -->
    </p>
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
        
      <span><a href="../changelog/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      <span style="margin-left: 15px"><a href="../build/" style="color: #fcfcfc">Next &raquo;</a></span>
    </span>
</div>

<!--
MkDocs version  : 0.12.2
Docs Build Date : 2015-06-03 12:46:44.617919
-->
</body>
</html>