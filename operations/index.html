<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>For DevOps - Trumpet</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "For DevOps";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Trumpet</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">What is Trumpet</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../architecture/">How it works</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../installation/">I want it!</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../applications/">Write your Apps</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">For DevOps</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#validate-correctness-and-completeness">Validate correctness and completeness</a></li>
                
            
                <li class="toctree-l3"><a href="#peek-kafka-topic">Peek Kafka topic</a></li>
                
            
                <li class="toctree-l3"><a href="#workers-status">Workers status</a></li>
                
            
                <li class="toctree-l3"><a href="#kafka-tools">Kafka Tools</a></li>
                
                    <li><a class="toctree-l4" href="#getting-the-latest-offset">Getting the latest offset</a></li>
                
                    <li><a class="toctree-l4" href="#peeking-kafka-topic">Peeking Kafka topic</a></li>
                
            
                <li class="toctree-l3"><a href="#graphite-integration">Graphite Integration</a></li>
                
                    <li><a class="toctree-l4" href="#graphite-samples">Graphite samples</a></li>
                
            
                <li class="toctree-l3"><a href="#typical-failure-illustrated">Typical Failure Illustrated</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../changelog/">Changelog</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../license/">License</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Trumpet</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>For DevOps</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p>To operate Trumpet on a day-to-day basis, tools are provided to help to understand quickly what's going on in Trumpet. 
And please keep in mind that all the tools are <code>--help</code> friendly, so abuse of the help!</p>
<h2 id="validate-correctness-and-completeness">Validate correctness and completeness</h2>
<p>A tool is provided which goes back in time as much it can both in the kafka topic and <code>dfs.*.name.dir</code> 
and validate that all the transactions in the edit log dir are in Kafka and match:</p>
<pre><code>$ /opt/trumpet/server/bin/events-validator.sh --zk.connect &lt;zk_ip:2181&gt; --dfs.edits.dir &lt;root_dir_where_edits_files_are_stored&gt; --numevents 1000000
</code></pre>

<h2 id="peek-kafka-topic">Peek Kafka topic</h2>
<p>At any time, you can peek the Kafka topic, i.e. retrieve and display in a console the <em>n</em> latest messages:</p>
<pre><code>$ /opt/trumpet/server/bin/peek-events.sh --zk.connect &lt;zk_ip:2181&gt; --numevents 100
</code></pre>

<p>If <code>com.verisign.vscc.hdfs.trumpet.server.tool.PeekInotifyEvents</code> logger is in debug mode, complete event is dumped into the command line. 
Really useful for debugging, while this might be noisy.</p>
<h2 id="workers-status">Workers status</h2>
<p>An utility is also provided to display the running Trumpet workers as well as which one is the leader</p>
<pre><code>$ /opt/trumpet/server/bin/status.sh --zk.connect &lt;zk_ip:2181&gt;
</code></pre>

<h2 id="kafka-tools">Kafka Tools</h2>
<p>You can also use <a href="https://cwiki.apache.org/confluence/display/KAFKA/System+Tools">plain Kafka tools</a> to find out if there are events flowing into the topic:</p>
<h3 id="getting-the-latest-offset">Getting the latest offset</h3>
<p>This tool will show you the latest (i.e, most recent) offest of the topic. Calling this function several time will let you show 
how many offset (i.e, inotify events) arrived in the topic:</p>
<pre><code>kafka-run-class kafka.tools.GetOffsetShell --broker-list &lt;broker:port&gt; --time -1 --topic hdfs.inotify.events
</code></pre>

<h3 id="peeking-kafka-topic">Peeking Kafka topic</h3>
<p>Just like the <code>peek-events.sh</code> Trumpet tool, you can display the messages that arrives in the topic because they are plain JSON messages:</p>
<pre><code>kafka-simple-consumer-shell --broker-list &lt;broker:port&gt; --topic hdfs.inotify.events --offset -1 --max-messages 5 --partition 0
</code></pre>

<h2 id="graphite-integration">Graphite Integration</h2>
<p>Trumpet relies on the awesome <a href="http://metrics.dropwizard.io/">Metics library</a> to collect metrics, 
like the transactionId actually processed, the number of event per seconds
published into Kafka, since when the current daemon is leader, ... 
See the <a href="../../server/src/main/java/com/verisign/vscc/hdfs/trumpet/server/metrics/Metrics.java">Metrics</a> 
class for more details.</p>
<p>To reports these metrics in <a href="http://graphite.wikidot.com/">Graphite</a> (or compatible graphite collectors), simply 
run <code>trumpet.sh</code> with <code>--graphite.server.hostport &lt;host&gt;:&lt;port&gt;</code> and you're all set. <code>&lt;port&gt;</code> is optional and is defaulted 
to 2003. <code>--graphite.prefix</code> can change the prefix of the metric reported in graphite, by default <code>trumpet.&lt;hostname&gt;</code>.</p>
<h3 id="graphite-samples">Graphite samples</h3>
<p><img alt="Processing Time" src="../processing_time.png" title="Time to process edit logs and send to Kafka" /></p>
<p><img alt="Transaction per Seconds" src="../tx_per_sec.png" title="Total transactions per seconds, tx to Kafka" /></p>
<h2 id="typical-failure-illustrated">Typical Failure Illustrated</h2>
<ul>
<li>Trumpet Server #1:</li>
</ul>
<pre><code>2015-06-04 03:11:53.565 DEBUG [Curator-LeaderSelector-0] c.v.v.h.t.s.rx.EditLogObservable - Processed 104 tx and streamed 80 events to the observer. Started at 2154122762 to last decoded txId 2154122865
...
2015-06-04 03:11:54.280 WARN [Curator-LeaderSelector-0] c.v.v.h.trumpet.server.TrumpetLeader - Got exception. Releasing leadership.
</code></pre>

<p>BAM, died, for whatever reason. Last transaction published is 2154122865</p>
<ul>
<li>Trumpet Server #2:</li>
</ul>
<p>Few milliseconds later, this Trumpet server intance takes over, starting from 2154122866</p>
<pre><code>2015-06-04 03:11:54.530 DEBUG [Curator-LeaderSelector-0] c.v.v.h.trumpet.server.TrumpetLeader - Elected as leader, let's stream!
2015-06-04 03:11:54.595 DEBUG [Curator-LeaderSelector-0] c.v.v.h.trumpet.server.TrumpetLeader - Retrieved lastPublishedTxId: 2154122865
2015-06-04 03:11:54.661 DEBUG [Curator-LeaderSelector-0] c.v.v.h.trumpet.server.TrumpetLeader - Reading editLog file /.../dfs/jn/journalhdfs1/current/edits_0000000002154116241-0000000002154123044 from tx 2154122866
</code></pre>

<p>Running the events-validator, as HDFS, to ensure that not transactions have been lost in between</p>
<pre><code>$ /opt/trumpet/server/bin/events-validator.sh --zk.connect ${zkConnect} --numevents 200000 --dfs.edits.dir /.../dfs/jn
Processing /app2/dfs/jn/journalhdfs1/current/edits_0000000002154094680-0000000002154105842 from tx 2154105374
Processing /app2/dfs/jn/journalhdfs1/current/edits_0000000002154105843-0000000002154116240 from tx 2154105843
...
Good, kafka topic hdfs.inotify.events and edit.log.dir com.verisign.vscc.hdfs.trumpet.server.editlog.EditLogDir[/.../dfs/jn/journalhdfs1/current] look consistent.

</code></pre>

<p>Alright, no transaction lost!</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../changelog/" class="btn btn-neutral float-right" title="Changelog"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../applications/" class="btn btn-neutral" title="Write your Apps"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../applications/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../changelog/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
